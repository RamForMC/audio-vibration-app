<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e1b4b">
    <title>Audio to Vibration Converter</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: none;
        }
        .video-container {
            position: relative;
            background: black;
            border-radius: 12px;
            overflow: hidden;
        }
        .video-container video {
            width: 100%;
            display: block;
        }
        .video-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
        }
        .video-container.fullscreen video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .video-container.fullscreen:hover .video-controls,
        .video-container.fullscreen .video-controls.active {
            opacity: 1;
        }
        .progress-bar {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }
        .progress-filled {
            height: 100%;
            background: #8b5cf6;
            border-radius: 2px;
            transition: width 0.1s;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div id="mainContainer" class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-3xl shadow-2xl p-6 text-white">
                <div class="text-center mb-6">
                    <div class="flex justify-center mb-3">
                        <div class="bg-white/20 p-4 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
                            </svg>
                        </div>
                    </div>
                    <h1 class="text-2xl font-bold mb-1">Audio to Vibration</h1>
                    <p class="text-sm text-white/70">Feel the rhythm</p>
                </div>

                <div id="errorBox" class="bg-red-500/20 border border-red-500/50 rounded-lg p-3 mb-4 text-sm hidden"></div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Select Audio/Video File</label>
                        <input type="file" accept="audio/*,video/*" id="fileInput" class="hidden">
                        <label for="fileInput" class="flex items-center justify-center gap-2 w-full bg-white/20 hover:bg-white/30 rounded-xl p-4 cursor-pointer transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/>
                            </svg>
                            <span class="text-sm" id="fileName">Choose file...</span>
                        </label>
                    </div>

                    <div id="videoContainer" class="video-container hidden">
                        <video id="mediaElement" playsinline></video>
                        <div class="video-controls" id="videoControls">
                            <button id="playPauseBtn" class="text-white p-2 hover:bg-white/20 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                            </button>
                            <div class="progress-bar" id="progressBar">
                                <div class="progress-filled" id="progressFilled"></div>
                            </div>
                            <button id="fullscreenBtn" class="text-white p-2 hover:bg-white/20 rounded">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <audio id="audioElement" class="hidden"></audio>

                    <div>
                        <label class="flex items-center gap-2 text-sm font-medium mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v6m10-10h-6M9 12H3"/>
                            </svg>
                            Sensitivity: <span id="sensitivityValue">50</span>%
                        </label>
                        <input type="range" min="0" max="100" value="50" id="sensitivitySlider" 
                               class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-white/60 mt-1">
                            <span>Less sensitive</span>
                            <span>More sensitive</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="playBtn" disabled class="flex-1 py-4 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 transition-all bg-white/10 cursor-not-allowed opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Play
                        </button>
                        <button id="fullscreenToggle" class="py-4 px-6 rounded-xl font-semibold bg-white/20 hover:bg-white/30 transition-all hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                            </svg>
                        </button>
                    </div>

                    <div id="playingIndicator" class="bg-white/10 rounded-xl p-4 text-center hidden">
                        <div class="flex justify-center mb-2">
                            <div class="w-16 h-16 border-4 border-purple-400 border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <p class="text-sm">Playing... Your phone should vibrate with the audio</p>
                        <p class="text-xs text-white/60 mt-1">Make sure your phone is not on silent mode</p>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-white/20 text-xs text-white/60 text-center">
                    <p>ðŸ“± Install this app: Tap your browser menu and select "Add to Home Screen"</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let isPlaying = false;
        let sensitivity = 50;
        let file = null;
        let isVideo = false;
        let isFullscreen = false;
        let audioContext = null;
        let analyser = null;
        let source = null;
        let animationFrame = null;

        // Elements
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const playBtn = document.getElementById('playBtn');
        const sensitivitySlider = document.getElementById('sensitivitySlider');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const errorBox = document.getElementById('errorBox');
        const playingIndicator = document.getElementById('playingIndicator');
        const videoContainer = document.getElementById('videoContainer');
        const audioElement = document.getElementById('audioElement');
        const mediaElement = document.getElementById('mediaElement');
        const progressBar = document.getElementById('progressBar');
        const progressFilled = document.getElementById('progressFilled');
        const fullscreenToggle = document.getElementById('fullscreenToggle');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const videoControls = document.getElementById('videoControls');
        const mainContainer = document.getElementById('mainContainer');

        // Check vibration support
        if (!navigator.vibrate) {
            showError('Vibration API not supported on this device');
        }

        // File selection
        fileInput.addEventListener('change', (e) => {
            const selectedFile = e.target.files[0];
            if (selectedFile) {
                const fileType = selectedFile.type;
                if (fileType.startsWith('audio/') || fileType.startsWith('video/')) {
                    file = selectedFile;
                    fileName.textContent = selectedFile.name;
                    isVideo = fileType.startsWith('video/');
                    hideError();
                    
                    const url = URL.createObjectURL(selectedFile);
                    const currentMedia = isVideo ? mediaElement : audioElement;
                    currentMedia.src = url;
                    
                    if (isVideo) {
                        videoContainer.classList.remove('hidden');
                        fullscreenToggle.classList.remove('hidden');
                    } else {
                        videoContainer.classList.add('hidden');
                        fullscreenToggle.classList.add('hidden');
                    }
                    
                    playBtn.disabled = false;
                    playBtn.classList.remove('bg-white/10', 'cursor-not-allowed', 'opacity-50');
                    playBtn.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-blue-500', 'hover:from-purple-600', 'hover:to-blue-600', 'shadow-lg');
                } else {
                    showError('Please select an audio or video file');
                }
            }
        });

        // Sensitivity slider
        sensitivitySlider.addEventListener('input', (e) => {
            sensitivity = Number(e.target.value);
            sensitivityValue.textContent = sensitivity;
            const bg = `linear-gradient(to right, #8b5cf6 0%, #8b5cf6 ${sensitivity}%, rgba(255,255,255,0.2) ${sensitivity}%, rgba(255,255,255,0.2) 100%)`;
            sensitivitySlider.style.background = bg;
        });

        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                const currentMedia = isVideo ? mediaElement : audioElement;
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 512;
                    analyser.smoothingTimeConstant = 0.8;
                    
                    source = audioContext.createMediaElementSource(currentMedia);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (err) {
                    console.error('Audio context error:', err);
                }
            }
        }

        // Test vibration on first interaction
        let vibrationTested = false;
        function testVibration() {
            if (!vibrationTested) {
                try {
                    navigator.vibrate(50);
                    vibrationTested = true;
                    console.log('Vibration test successful');
                } catch (e) {
                    console.error('Vibration test failed:', e);
                    showError('Vibration not working. Check phone settings.');
                }
            }
        }

        // Analyze audio and vibrate
        function analyzeAudio() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            let lastVibrationTime = 0;
            
            function analyze() {
                if (!isPlaying) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                // Calculate volume across frequency ranges
                let total = 0;
                let bassSum = 0;
                let midSum = 0;
                
                // Bass frequencies (most impactful for vibration)
                for (let i = 0; i < 40; i++) {
                    bassSum += dataArray[i];
                }
                
                // Mid frequencies
                for (let i = 40; i < 120; i++) {
                    midSum += dataArray[i];
                }
                
                for (let i = 0; i < bufferLength; i++) {
                    total += dataArray[i];
                }
                
                const bassAvg = bassSum / 40;
                const midAvg = midSum / 80;
                const overallAvg = total / bufferLength;
                
                // Weighted combination favoring bass
                const combined = (bassAvg * 0.6 + midAvg * 0.3 + overallAvg * 0.1);
                
                // Dynamic threshold based on sensitivity
                const threshold = (100 - sensitivity) * 1.2;
                
                const now = Date.now();
                
                // Vibrate if above threshold and enough time has passed (prevent too frequent vibrations)
                if (combined > threshold && (now - lastVibrationTime) > 50) {
                    // Map to vibration duration (20-150ms for better feel)
                    const intensity = Math.max(20, Math.min(Math.floor((combined / 255) * 150), 150));
                    
                    try {
                        // Use vibration pattern for better effect
                        if (navigator.vibrate) {
                            navigator.vibrate(intensity);
                            lastVibrationTime = now;
                            console.log('Vibrating:', intensity, 'ms at level:', combined.toFixed(1));
                        }
                    } catch (e) {
                        console.error('Vibration error:', e);
                    }
                }
                
                animationFrame = requestAnimationFrame(analyze);
            }
            
            analyze();
        }

        // Play/Stop
        playBtn.addEventListener('click', async () => {
            if (!file) {
                showError('Please select a file first');
                return;
            }

            // Test vibration on first click
            testVibration();

            if (isPlaying) {
                stopPlayback();
            } else {
                try {
                    if (!audioContext) {
                        initAudioContext();
                    }
                    
                    if (audioContext && audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    const currentMedia = isVideo ? mediaElement : audioElement;
                    
                    // Request wake lock to prevent screen from sleeping
                    if ('wakeLock' in navigator) {
                        try {
                            const wakeLock = await navigator.wakeLock.request('screen');
                            console.log('Wake lock acquired');
                        } catch (err) {
                            console.log('Wake lock error:', err);
                        }
                    }
                    
                    await currentMedia.play();
                    isPlaying = true;
                    
                    if (analyser) {
                        console.log('Starting audio analysis...');
                        analyzeAudio();
                    } else {
                        showError('Audio analyzer not initialized');
                    }
                    
                    playBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg> Stop';
                    playingIndicator.classList.remove('hidden');
                    hideError();
                } catch (err) {
                    showError('Error playing file: ' + err.message);
                    console.error('Playback error:', err);
                }
            }
        });

        function stopPlayback() {
            const currentMedia = isVideo ? mediaElement : audioElement;
            currentMedia.pause();
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            
            try {
                navigator.vibrate(0);
            } catch (e) {}
            
            isPlaying = false;
            playBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg> Play';
            playingIndicator.classList.add('hidden');
        }

        // Fullscreen
        async function toggleFullscreen() {
            if (!isFullscreen) {
                try {
                    if (document.documentElement.requestFullscreen) {
                        await document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        await document.documentElement.webkitRequestFullscreen();
                    }
                    
                    if (screen.orientation && screen.orientation.lock) {
                        try {
                            await screen.orientation.lock('landscape');
                        } catch (e) {
                            console.log('Orientation lock not supported');
                        }
                    }
                    
                    videoContainer.classList.add('fullscreen');
                    mainContainer.classList.add('hidden');
                    videoControls.classList.add('active');
                    isFullscreen = true;
                } catch (err) {
                    console.error('Fullscreen error:', err);
                }
            } else {
                try {
                    if (document.exitFullscreen) {
                        await document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        await document.webkitExitFullscreen();
                    }
                    
                    if (screen.orientation && screen.orientation.unlock) {
                        screen.orientation.unlock();
                    }
                    
                    videoContainer.classList.remove('fullscreen');
                    mainContainer.classList.remove('hidden');
                    videoControls.classList.remove('active');
                    isFullscreen = false;
                } catch (err) {
                    console.error('Exit fullscreen error:', err);
                }
            }
        }

        fullscreenToggle.addEventListener('click', toggleFullscreen);
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        // Fullscreen change events
        document.addEventListener('fullscreenchange', () => {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            if (!isCurrentlyFullscreen && isFullscreen) {
                videoContainer.classList.remove('fullscreen');
                mainContainer.classList.remove('hidden');
                videoControls.classList.remove('active');
                isFullscreen = false;
            }
        });

        document.addEventListener('webkitfullscreenchange', () => {
            const isCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            if (!isCurrentlyFullscreen && isFullscreen) {
                videoContainer.classList.remove('fullscreen');
                mainContainer.classList.remove('hidden');
                videoControls.classList.remove('active');
                isFullscreen = false;
            }
        });

        // Video controls
        playPauseBtn.addEventListener('click', async () => {
            testVibration();
            
            if (isPlaying) {
                stopPlayback();
            } else {
                try {
                    if (!audioContext) {
                        initAudioContext();
                    }
                    
                    if (audioContext && audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    await mediaElement.play();
                    isPlaying = true;
                    
                    if (analyser) {
                        analyzeAudio();
                    }
                    
                    playBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg> Stop';
                } catch (err) {
                    showError('Error: ' + err.message);
                }
            }
        });

        // Progress bar
        progressBar.addEventListener('click', (e) => {
            const rect = progressBar.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            mediaElement.currentTime = pos * mediaElement.duration;
        });

        // Update progress
        setInterval(() => {
            const currentMedia = isVideo ? mediaElement : audioElement;
            if (currentMedia && currentMedia.duration) {
                const progress = (currentMedia.currentTime / currentMedia.duration) * 100;
                progressFilled.style.width = progress + '%';
            }
        }, 100);

        // Error handling
        function showError(message) {
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }
    </script>
</body>
</html>
